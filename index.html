<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Autoevaluación de la asignatura</title>

<style>
/* ==== DISEÑO (se mantiene igual que el tuyo actual) ==== */
body { font-family: Arial, sans-serif; background:#f4f6f9; text-align:center; padding:40px; }
.contenedor { background:#fff; padding:30px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,.1); max-width:920px; margin:auto; }

.header {
display:grid;
grid-template-columns: 90px 1fr 90px;
align-items:center;
gap:16px;
margin-bottom: 10px;
}

.logo { width:90px; }

.header-text { text-align:center; }
.header-text .linea1 { font-size:20px; font-weight:bold; }
.header-text .linea2 { font-size:16px; }
.header-text .linea3 { font-size:15px; }

h1 { margin:12px 0 6px; font-size:26px; color:#2c7be5; }

.estado {
margin-top:12px;
font-size:16px;
font-weight:700;
color:#0B6E4F;
}

.caja-pregunta{
max-width:740px;
margin:10px auto 16px;
background:#111;
color:#fff;
border-radius:10px;
padding:14px;
}

#enunciado{
margin:0;
font-size:20px;
}

#opciones {
max-width:680px;
margin:0 auto;
}

.opcion {
display:block;
width:100%;
margin:8px 0;
border-radius:6px;
padding:10px;
font-size:16px;
color:#fff;
background:#2c7be5;
border:0;
cursor:pointer;
}

.feedback {
margin:12px auto 0;
padding:12px;
border-radius:8px;
display:none;
max-width:680px;
text-align:left;
}

.footer {
margin-top:22px;
padding-top:14px;
border-top:2px solid #9ec5fe;
position:relative;
font-size:13px;
text-align:left;
min-height:110px;
}

.grupos {
position:absolute;
right:0;
bottom:0;
display:grid;
grid-template-columns:1fr 1fr;
gap:10px;
text-align:center;
}

.grupo { width:60px; }

.grupo img { width:33px; }

.grupo .caption {
font-size:7px;
white-space:nowrap;
}
</style>
</head>

<body>
<div class="contenedor">

<h1>Autoevaluación de la asignatura</h1>

<select id="seleccion"></select>
<button onclick="iniciarPartida()">Comenzar</button>

<div id="panelJuego" style="display:none;">
<div class="estado" id="estado"></div>
<div class="caja-pregunta">
<h3 id="enunciado"></h3>
</div>
<div id="opciones"></div>
<div id="feedback" class="feedback"></div>
</div>

<div id="panelFinal"></div>

<div class="footer">
<p><strong>Proyecto de Innovación Docente UNED</strong></p>

<div class="grupos">
<div class="grupo">
<img src="logo-radte.png">
<div class="caption">
<a href="https://www.uned.es/universidad/inicio/investigacion/Institutos-centros-grupos-investigacion/grupos-investigacion/estrategias-metodologicas-para-la-construccion-de-una-red-a-distancia-de-tecnologia-educativa.html?idContenido=1" target="_blank">RADTE</a>
</div>
</div>

<div class="grupo">
<img src="logo-mape-tic.png">
<div class="caption">
<a href="https://www.uned.es/universidad/inicio/unidad/IUED/innovacion/grupos-innovacion/grupo-22.html" target="_blank">MAPE-TIC</a>
</div>
</div>
</div>
</div>

</div>

<script>
const NUM_PREGUNTAS_POR_PARTIDA = 10;
const MIN_TEMAS_DISTINTOS = 4;  // <-- DIVERSIDAD CONFIGURABLE

let bancoTemas = {};
let bancoExamenes = {};
let seleccionActual = "";
let partida = [];
let indice = 0;
let aciertos = 0;

/* ==== UTILIDADES ==== */

function barajar(array) {
for (let i = array.length - 1; i > 0; i--) {
const j = Math.floor(Math.random() * (i + 1));
[array[i], array[j]] = [array[j], array[i]];
}
return array;
}

function seleccionarDiversificado() {

let seleccionadas = [];
let temasDisponibles = Object.keys(bancoTemas).filter(t => bancoTemas[t].length > 0);

barajar(temasDisponibles);

let temasElegidos = temasDisponibles.slice(0, MIN_TEMAS_DISTINTOS);

temasElegidos.forEach(t => {
let preguntasTema = [...bancoTemas[t]];
barajar(preguntasTema);
seleccionadas.push(preguntasTema[0]);
});

let poolCompleto = Object.values(bancoTemas).flat();
barajar(poolCompleto);

for (let p of poolCompleto) {
if (seleccionadas.length >= NUM_PREGUNTAS_POR_PARTIDA) break;
if (!seleccionadas.includes(p)) {
seleccionadas.push(p);
}
}

return barajar(seleccionadas);
}

function seleccionarDiversificadoTotal() {

let seleccionadas = seleccionarDiversificado();

let examenesPool = Object.values(bancoExamenes).flat();
if (examenesPool.length > 0) {
barajar(examenesPool);
if (Math.random() < 0.7) {  // 70% probabilidad de incluir al menos 1 examen
seleccionadas.pop();
seleccionadas.push(examenesPool[0]);
}
}

return barajar(seleccionadas);
}

/* ==== CARGA ==== */

window.onload = function() {
fetch("questions.json")
.then(r => r.json())
.then(data => {
bancoTemas = data.temas || {};
bancoExamenes = data.examenes || {};
cargarSelector();
});
};

function cargarSelector() {
const sel = document.getElementById("seleccion");
sel.innerHTML = "";

sel.innerHTML += `<option value="mix_temas">Mezcla de temas</option>`;
sel.innerHTML += `<option value="mix_examenes">Mezcla de exámenes</option>`;
sel.innerHTML += `<option value="mix_total">Mezcla total</option>`;

Object.keys(bancoTemas).forEach(t => {
sel.innerHTML += `<option value="tema::${t}">${t}</option>`;
});

Object.keys(bancoExamenes).forEach(e => {
sel.innerHTML += `<option value="examen::${e}">Examen ${e}</option>`;
});
}

/* ==== PARTIDA ==== */

function iniciarPartida() {

seleccionActual = document.getElementById("seleccion").value;

if (seleccionActual === "mix_temas") {
partida = seleccionarDiversificado();
}
else if (seleccionActual === "mix_total") {
partida = seleccionarDiversificadoTotal();
}
else if (seleccionActual === "mix_examenes") {
let pool = Object.values(bancoExamenes).flat();
barajar(pool);
partida = pool.slice(0, NUM_PREGUNTAS_POR_PARTIDA);
}
else if (seleccionActual.startsWith("tema::")) {
let t = seleccionActual.split("tema::")[1];
let pool = [...bancoTemas[t]];
barajar(pool);
partida = pool.slice(0, NUM_PREGUNTAS_POR_PARTIDA);
}
else if (seleccionActual.startsWith("examen::")) {
let e = seleccionActual.split("examen::")[1];
let pool = [...bancoExamenes[e]];
barajar(pool);
partida = pool.slice(0, NUM_PREGUNTAS_POR_PARTIDA);
}

indice = 0;
aciertos = 0;

document.getElementById("panelJuego").style.display = "block";
mostrarPregunta();
}

function mostrarPregunta() {
if (indice >= partida.length) return;

let p = partida[indice];

document.getElementById("estado").textContent =
"Pregunta " + (indice+1) + " / 10 | Aciertos: " + aciertos;

document.getElementById("enunciado").textContent =
"Pregunta: " + p.pregunta;

let opciones = document.getElementById("opciones");
opciones.innerHTML = "";

p.opciones.forEach((o,i)=>{
let b = document.createElement("button");
b.className="opcion";
b.textContent=o;
b.onclick=()=>responder(i);
opciones.appendChild(b);
});
}

function responder(i) {
let p = partida[indice];

if (i===p.correcta) aciertos++;

indice++;
mostrarPregunta();
}
</script>

</body>
</html>
